# テーブル定義書

## 概要
タスク管理アプリのデータベース設計書です。本書では、データベースの物理設計、テーブル構造、制約、インデックス、トリガーなどの詳細仕様を定義します。

## データベース情報
- **データベース名**: taskmanager
- **RDBMS**: PostgreSQL 15
- **文字コード**: UTF-8
- **タイムゾーン**: UTC
- **照合順序**: ja_JP.UTF-8

## テーブル一覧

| No | テーブル名 | 論理名 | 用途 | レコード数見積 |
|----|-----------|--------|------|---------------|
| 1  | tasks     | タスクテーブル | タスク情報を管理 | 10,000件/年 |

---

## 1. tasksテーブル

### 概要
タスクの基本情報を管理するメインテーブル。CRUD操作の中核となるエンティティです。

### 物理テーブル名
```sql
tasks
```

### テーブル定義

| No | カラム名 | 論理名 | データ型 | サイズ | NULL | デフォルト値 | 備考 |
|----|----------|--------|----------|--------|------|-------------|------|
| 1  | id | ID | SERIAL | 4byte | NOT NULL | AUTO_INCREMENT | 主キー（自動採番） |
| 2  | title | タスクタイトル | VARCHAR | 255 | NOT NULL | - | タスクの名前 |
| 3  | description | タスク説明 | TEXT | 無制限 | NULL | NULL | タスクの詳細説明 |
| 4  | deadline | 期限 | DATE | 4byte | NULL | NULL | タスクの期限日 |
| 5  | assignee | 担当者 | VARCHAR | 100 | NULL | NULL | タスクの担当者名 |
| 6  | status | ステータス | VARCHAR | 20 | NOT NULL | 'pending' | pending/in_progress/completed |
| 7  | created_at | 作成日時 | TIMESTAMP WITH TIME ZONE | 8byte | NOT NULL | CURRENT_TIMESTAMP | レコード作成日時 |
| 8  | updated_at | 更新日時 | TIMESTAMP WITH TIME ZONE | 8byte | NOT NULL | CURRENT_TIMESTAMP | レコード更新日時 |

### DDL文
```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    deadline DATE,
    assignee VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 制約定義

#### 主キー制約
- **制約名**: tasks_pkey
- **制約種類**: PRIMARY KEY
- **対象カラム**: id
- **DDL**: `ALTER TABLE tasks ADD CONSTRAINT tasks_pkey PRIMARY KEY (id);`

#### チェック制約
- **制約名**: chk_tasks_status
- **制約種類**: CHECK
- **対象カラム**: status
- **条件**: status IN ('pending', 'in_progress', 'completed')
- **DDL**: `ALTER TABLE tasks ADD CONSTRAINT chk_tasks_status CHECK (status IN ('pending', 'in_progress', 'completed'));`

#### 長さ制約
- **制約名**: chk_tasks_title_length
- **制約種類**: CHECK
- **対象カラム**: title
- **条件**: LENGTH(TRIM(title)) > 0
- **DDL**: `ALTER TABLE tasks ADD CONSTRAINT chk_tasks_title_length CHECK (LENGTH(TRIM(title)) > 0);`

### インデックス定義

| インデックス名 | 種類 | 対象カラム | 用途 | カーディナリティ |
|---------------|------|-----------|------|-----------------|
| tasks_pkey | UNIQUE | id | 主キー | 高 |
| idx_tasks_status | BTREE | status | ステータス検索 | 低 |
| idx_tasks_deadline | BTREE | deadline | 期限検索・ソート | 中 |
| idx_tasks_assignee | BTREE | assignee | 担当者検索 | 中 |
| idx_tasks_created_at | BTREE | created_at | 作成日時ソート | 高 |
| idx_tasks_composite | BTREE | status, deadline | 複合検索 | 中 |

#### インデックス作成DDL
```sql
-- 基本インデックス
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_deadline ON tasks(deadline);
CREATE INDEX idx_tasks_assignee ON tasks(assignee);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);

-- 複合インデックス（ステータスと期限の組み合わせ検索用）
CREATE INDEX idx_tasks_composite ON tasks(status, deadline);

-- 部分インデックス（期限切れタスク検索用）
CREATE INDEX idx_tasks_overdue ON tasks(deadline) 
WHERE deadline < CURRENT_DATE AND status != 'completed';
```

### トリガー定義

#### 更新日時自動更新トリガー
```sql
-- トリガー関数作成
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- トリガー作成
CREATE TRIGGER trigger_tasks_updated_at
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### ステータス値定義

| 値 | 論理名 | 説明 | 遷移可能な状態 |
|----|--------|------|---------------|
| pending | 未着手 | タスクが登録されたが、まだ開始されていない状態 | in_progress |
| in_progress | 進行中 | タスクが実行中の状態 | completed, pending |
| completed | 完了 | タスクが完了した状態 | pending, in_progress |

### データ整合性ルール

#### 必須入力項目
1. **title**: タスクタイトルは必須項目
2. **status**: ステータスは必須項目（デフォルト値あり）

#### 自動設定項目
1. **id**: シーケンスによる自動採番
2. **created_at**: レコード作成時に自動設定
3. **updated_at**: レコード更新時に自動更新

#### データ形式ルール
1. **title**: 空文字・空白文字のみは不可
2. **deadline**: 日付形式（YYYY-MM-DD）、過去日付も許可
3. **assignee**: 100文字以内
4. **status**: 定義された値のみ許可

### パフォーマンス考慮事項

#### 想定クエリパターン
1. ステータス別タスク一覧取得
2. 担当者別タスク一覧取得
3. 期限日範囲でのタスク検索
4. 期限切れタスク検索
5. 作成日時順でのタスク一覧表示

#### 最適化ポイント
1. **idx_tasks_status**: WHERE status = 'pending' などの検索
2. **idx_tasks_deadline**: ORDER BY deadline, WHERE deadline BETWEEN などの検索
3. **idx_tasks_assignee**: WHERE assignee = 'ユーザー名' などの検索
4. **idx_tasks_composite**: WHERE status = 'pending' AND deadline < '2025-01-01' などの複合検索

### 容量見積

#### 1レコードあたりのサイズ
- id: 4byte
- title: 平均50文字 = 150byte (UTF-8)
- description: 平均200文字 = 600byte (UTF-8)
- deadline: 4byte
- assignee: 平均20文字 = 60byte (UTF-8)
- status: 平均10文字 = 30byte (UTF-8)
- created_at: 8byte
- updated_at: 8byte
- **合計**: 約864byte/レコード

#### 年間データ量見積
- レコード数: 10,000件/年
- データサイズ: 864byte × 10,000 = 8.64MB/年
- インデックスサイズ: 約3MB/年
- **総容量**: 約12MB/年

### バックアップ・運用考慮事項

#### バックアップ対象
- テーブルデータ全体
- インデックス定義
- トリガー定義
- 制約定義

#### 運用時注意点
1. 大量データ削除時はVACUUM実行推奨
2. インデックス統計情報の定期更新（ANALYZE）
3. パーティション分割の検討（100万件超過時）