# シーケンス図

## 概要
タスク管理アプリケーションの主要な操作フローにおける、フロントエンド・バックエンド・データベース間の処理シーケンスを図示します。

## 1. タスク一覧表示シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: タスク一覧画面にアクセス
    F->>F: loader関数実行
    F->>B: GET /api/v1/tasks?page=1&size=20
    B->>D: SELECT * FROM tasks LIMIT 20 OFFSET 0
    D-->>B: タスクデータリスト
    B->>D: SELECT COUNT(*) FROM tasks
    D-->>B: 総件数
    B-->>F: TaskListResponse<br/>{tasks, total, page, size, total_pages}
    F->>F: タスクリストをレンダリング
    F-->>U: タスク一覧画面表示
    
    Note over F,B: フィルタリング時は追加のクエリパラメータ<br/>(status, assignee, deadline_from等)を付与
```

## 2. タスク詳細表示シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: タスク詳細ボタンクリック
    F->>F: /tasks/:id に遷移
    F->>F: useParams()でタスクID取得
    F->>B: GET /api/v1/tasks/{task_id}
    B->>D: SELECT * FROM tasks WHERE id = {task_id}
    
    alt タスクが存在する場合
        D-->>B: タスクデータ
        B-->>F: TaskResponse
        F->>F: タスク詳細をレンダリング
        F-->>U: タスク詳細画面表示
    else タスクが存在しない場合
        D-->>B: NULL
        B-->>F: 404 Not Found
        F->>F: エラーメッセージ表示
        F-->>U: "タスクが見つかりません"
    end
```

## 3. タスク作成シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: 新規作成ボタンクリック
    F->>F: /tasks/new に遷移
    F-->>U: 作成フォーム表示
    
    U->>F: フォーム入力
    F->>F: リアルタイムバリデーション
    
    U->>F: 作成ボタンクリック
    F->>F: action関数実行
    F->>F: フォームデータバリデーション
    
    alt バリデーション成功
        F->>B: POST /api/v1/tasks<br/>{title, description, deadline, assignee}
        B->>B: Pydanticスキーマバリデーション
        
        alt サーバーサイドバリデーション成功
            B->>D: INSERT INTO tasks VALUES (...)
            D->>D: トランザクション開始
            D-->>B: 新規タスクID
            B->>D: COMMIT
            B-->>F: TaskCreateResponse<br/>{message, task}
            F->>F: redirect(/tasks/{new_task_id})
            F-->>U: タスク詳細画面に遷移
        else サーバーサイドバリデーション失敗
            B-->>F: 422 Validation Error
            F->>F: エラーメッセージ表示
            F-->>U: フォームエラー表示
        end
    else クライアントサイドバリデーション失敗
        F->>F: エラーメッセージ表示
        F-->>U: フォームエラー表示
    end
```

## 4. タスク更新シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: タスク編集ボタンクリック
    F->>F: /tasks/:id/edit に遷移
    F->>F: loader関数実行
    F->>B: GET /api/v1/tasks/{task_id}
    B->>D: SELECT * FROM tasks WHERE id = {task_id}
    D-->>B: 既存タスクデータ
    B-->>F: TaskResponse
    F->>F: フォームに既存値を設定
    F-->>U: 編集フォーム表示
    
    U->>F: フォーム修正
    F->>F: リアルタイムバリデーション
    
    U->>F: 更新ボタンクリック
    F->>F: action関数実行
    F->>F: 変更されたフィールドのみ抽出
    
    alt 変更がある場合
        F->>B: PUT /api/v1/tasks/{task_id}<br/>{変更されたフィールドのみ}
        B->>B: 更新対象フィールド確認
        B->>D: UPDATE tasks SET ... WHERE id = {task_id}
        D->>D: トランザクション開始
        D-->>B: 更新行数
        
        alt 更新成功
            B->>D: COMMIT
            B->>D: SELECT * FROM tasks WHERE id = {task_id}
            D-->>B: 更新後タスクデータ
            B-->>F: TaskResponse
            F->>F: redirect(/tasks/{task_id})
            F-->>U: タスク詳細画面に遷移
        else タスクが見つからない
            B-->>F: 404 Not Found
            F-->>U: エラーメッセージ表示
        end
    else 変更がない場合
        F-->>U: "変更がありません"メッセージ
    end
```

## 5. タスク削除シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: 削除ボタンクリック
    F->>F: confirm()ダイアログ表示
    
    alt ユーザーが削除を確認
        U->>F: OKクリック
        
        Note over F,B: 削除前確認情報取得（オプション）
        F->>B: GET /api/v1/tasks/{task_id}/delete-confirmation
        B->>D: SELECT * FROM tasks WHERE id = {task_id}
        D-->>B: タスクデータ
        B->>B: 警告メッセージ生成
        B-->>F: TaskDeleteConfirmationResponse<br/>{task, warning_message}
        
        F->>B: DELETE /api/v1/tasks/{task_id}
        B->>D: SELECT * FROM tasks WHERE id = {task_id}
        
        alt タスクが存在する場合
            D-->>B: 削除対象タスクデータ
            B->>D: DELETE FROM tasks WHERE id = {task_id}
            D->>D: トランザクション開始
            D-->>B: 削除行数
            B->>D: COMMIT
            B-->>F: TaskDeleteResponse<br/>{message, deleted_task}
            F->>F: navigate("/tasks")
            F-->>U: タスク一覧画面に遷移
            F->>F: "タスクが削除されました"表示
        else タスクが存在しない場合
            D-->>B: NULL
            B-->>F: 404 Not Found
            F->>F: alert()でエラー表示
            F-->>U: "タスクの削除に失敗しました"
        end
    else ユーザーが削除をキャンセル
        U->>F: キャンセルクリック
        F-->>U: 操作なし（詳細画面のまま）
    end
```

## 6. エラーハンドリングシーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: 任意の操作実行
    F->>B: API リクエスト
    
    alt データベース接続エラー
        B->>D: データベースクエリ
        D-->>B: 接続エラー
        B->>B: SQLAlchemyError キャッチ
        B->>D: ROLLBACK
        B-->>F: 500 Internal Server Error<br/>{"detail": "データベースエラーが発生しました"}
        F->>F: ApiError インスタンス生成
        F->>F: console.error() でログ出力
        F->>F: alert() でユーザー通知
        F-->>U: "ネットワークエラーが発生しました"
    else バリデーションエラー
        B->>B: Pydanticバリデーション失敗
        B-->>F: 422 Unprocessable Entity<br/>{"detail": "バリデーションエラー詳細"}
        F->>F: フォームエラー状態更新
        F-->>U: フィールド単位のエラーメッセージ表示
    else リソースが見つからない
        B->>D: SELECT クエリ
        D-->>B: 結果なし
        B-->>F: 404 Not Found<br/>{"detail": "ID X のタスクが見つかりません"}
        F->>F: エラーページ表示
        F-->>U: "タスクが見つかりません"ページ
    else ネットワークエラー
        F->>B: fetch() リクエスト
        B-->>F: ネットワーク接続失敗
        F->>F: fetch() Promise reject
        F->>F: ApiError("ネットワークエラーが発生しました", 0)
        F-->>U: "サーバーに接続できません"
    end
```

## 7. フィルター・検索シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド<br/>(React)
    participant B as バックエンド<br/>(FastAPI)
    participant D as データベース<br/>(PostgreSQL)

    U->>F: タスク一覧画面でフィルター操作
    F->>F: useState でフィルター状態更新
    
    U->>F: 検索語入力/ステータス選択/担当者選択
    F->>F: useEffect でフィルター変更検知
    F->>F: URLクエリパラメータ構築
    
    F->>B: GET /api/v1/tasks?page=1&size=20&status=pending&assignee=田中太郎
    B->>B: クエリパラメータ解析
    B->>D: SELECT * FROM tasks<br/>WHERE status = 'pending'<br/>AND assignee = '田中太郎'<br/>LIMIT 20 OFFSET 0
    D-->>B: フィルター済みタスクリスト
    B->>D: SELECT COUNT(*) FROM tasks<br/>WHERE status = 'pending'<br/>AND assignee = '田中太郎'
    D-->>B: フィルター済み総件数
    B-->>F: TaskListResponse (フィルター済み)
    F->>F: useState でタスクリスト更新
    F-->>U: フィルター済み一覧表示
    
    Note over F: リアルタイム検索の場合は<br/>debounce処理を実装
```

## 技術的な詳細

### 1. トランザクション管理
- データベース操作はトランザクション内で実行
- エラー発生時は自動ロールバック
- 成功時のみコミット実行

### 2. エラーハンドリング階層
1. **データベース層**: SQLAlchemy例外をキャッチ
2. **アプリケーション層**: ビジネスロジック例外をHTTPExceptionに変換
3. **API層**: HTTPExceptionをJSONレスポンスに変換
4. **フロントエンド層**: APIエラーをユーザー向けメッセージに変換

### 3. レスポンシブ処理
- API呼び出し中はローディング状態表示
- `useNavigation()` フックで遷移状態を管理
- ユーザー操作の重複実行を防止

### 4. データ同期
- フォーム送信後はサーバーから最新データを取得
- 楽観的更新は実装していない（安全性を重視）
- キャッシュ機能は現在未実装

### 5. セキュリティ考慮事項
- SQL インジェクション対策：ORMによるパラメータ化クエリ
- XSS 対策：Reactの自動エスケープ機能
- CSRF 対策：現在未実装（将来の拡張課題）