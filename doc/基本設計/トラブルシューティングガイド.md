# タスク管理アプリ トラブルシューティングガイド

## 概要

本文書は、タスク管理アプリケーションの環境構築および運用時に発生する可能性のある問題と解決方法をまとめたトラブルシューティングガイドです。

## Docker関連の問題

### 1. Dockerコンテナが起動しない

#### 問題：`docker compose up` でエラーが発生する

**症状**：
```
ERROR: Could not find a version that satisfies the requirement
```

**原因と解決方法**：

1. **Dockerが起動していない**
   ```bash
   # Docker状態確認
   docker info
   
   # Dockerサービス起動（Linux）
   sudo systemctl start docker
   
   # Docker Desktop起動（Windows/Mac）
   # Docker Desktopアプリケーションを起動
   ```

2. **ポートが既に使用されている**
   ```bash
   # ポート使用状況確認
   netstat -tulpn | grep :3000
   netstat -tulpn | grep :8000
   netstat -tulpn | grep :5432
   
   # プロセス終了
   sudo kill -9 <PID>
   
   # または別のポートを使用
   # docker-compose.yml で ports を変更
   ```

3. **ディスク容量不足**
   ```bash
   # ディスク容量確認
   df -h
   
   # Docker使用量確認
   docker system df
   
   # 不要なイメージ・コンテナを削除
   docker system prune -a
   ```

### 2. コンテナビルドエラー

#### 問題：イメージビルドが失敗する

**症状**：
```
ERROR: failed to build: failed to copy: stat /var/lib/docker/tmp/docker-builder
```

**解決方法**：

1. **キャッシュクリア**
   ```bash
   # ビルドキャッシュをクリア
   docker builder prune
   
   # イメージを再ビルド
   docker compose build --no-cache
   ```

2. **Dockerfileの権限問題**
   ```bash
   # ファイル権限確認
   ls -la app/backend/Dockerfile
   ls -la app/frontend/Dockerfile
   
   # 権限修正
   chmod 644 app/*/Dockerfile
   ```

3. **WSL2での権限問題（Windows）**
   ```bash
   # WSL2でファイル権限をリセット
   sudo chmod -R 755 .
   
   # Windowsから WSL2 への パス変換確認
   wsl --list --verbose
   ```

## ネットワーク関連の問題

### 3. サービス間通信エラー

#### 問題：フロントエンドからバックエンドAPIにアクセスできない

**症状**：
```
Network Error: CORS error
Failed to fetch: TypeError: Failed to fetch
```

**解決方法**：

1. **CORS設定確認**
   ```python
   # app/backend/main.py
   from fastapi.middleware.cors import CORSMiddleware
   
   app.add_middleware(
       CORSMiddleware,
       allow_origins=["http://localhost:3000"],
       allow_credentials=True,
       allow_methods=["*"],
       allow_headers=["*"],
   )
   ```

2. **ネットワーク接続確認**
   ```bash
   # コンテナ間通信テスト
   docker compose exec frontend curl http://backend:8000/health
   
   # ホストからの接続テスト
   curl http://localhost:8000/health
   ```

3. **環境変数確認**
   ```bash
   # フロントエンド環境変数確認
   docker compose exec frontend env | grep REACT_APP
   
   # バックエンド環境変数確認
   docker compose exec backend env | grep DATABASE
   ```

### 4. データベース接続エラー

#### 問題：バックエンドからデータベースに接続できない

**症状**：
```
sqlalchemy.exc.OperationalError: could not connect to server
FATAL: database "taskmanager" does not exist
```

**解決方法**：

1. **データベース起動確認**
   ```bash
   # データベースコンテナ状態確認
   docker compose ps database
   
   # データベースヘルスチェック
   docker compose exec database pg_isready -U postgres -d taskmanager
   ```

2. **データベース手動作成**
   ```bash
   # データベースコンテナに接続
   docker compose exec database psql -U postgres
   
   # データベース作成
   CREATE DATABASE taskmanager;
   \l  # データベース一覧確認
   \q  # 終了
   ```

3. **接続文字列確認**
   ```bash
   # 環境変数確認
   echo $DATABASE_URL
   
   # 正しい形式例
   postgresql://postgres:postgres@database:5432/taskmanager
   ```

## アプリケーション関連の問題

### 5. フロントエンド表示エラー

#### 問題：React アプリケーションが正常に表示されない

**症状**：
```
Cannot resolve module 'react-router'
Module not found: Can't resolve '@/components/Navigation'
```

**解決方法**：

1. **依存関係再インストール**
   ```bash
   # コンテナ内で再インストール
   docker compose exec frontend npm install
   
   # ローカルで再インストール
   cd app/frontend
   rm -rf node_modules package-lock.json
   npm install
   ```

2. **TypeScript設定確認**
   ```bash
   # TypeScript設定確認
   docker compose exec frontend npx tsc --noEmit
   
   # tsconfig.json の paths 設定確認
   cat app/frontend/tsconfig.json
   ```

3. **ビルドエラー確認**
   ```bash
   # フロントエンドビルドテスト
   docker compose exec frontend npm run build
   
   # エラーログ詳細表示
   docker compose logs frontend
   ```

### 6. バックエンドAPIエラー

#### 問題：FastAPI サーバーが正常に起動しない

**症状**：
```
ImportError: No module named 'fastapi'
uvicorn.error: Error loading ASGI app
```

**解決方法**：

1. **Python依存関係確認**
   ```bash
   # Pythonパッケージ確認
   docker compose exec backend pip list
   
   # 依存関係再インストール
   docker compose exec backend pip install -r requirements.txt
   ```

2. **Python パス設定**
   ```bash
   # PYTHONPATH確認
   docker compose exec backend echo $PYTHONPATH
   
   # 手動でパス設定
   export PYTHONPATH=/app:$PYTHONPATH
   ```

3. **アプリケーション起動テスト**
   ```bash
   # 手動でサーバー起動
   docker compose exec backend uvicorn main:app --host 0.0.0.0 --port 8000
   
   # モジュールインポートテスト
   docker compose exec backend python -c "import app.models"
   ```

## パフォーマンス関連の問題

### 7. 動作が遅い・レスポンスが悪い

#### 問題：アプリケーションの動作が重い

**解決方法**：

1. **リソース使用量確認**
   ```bash
   # コンテナリソース監視
   docker stats
   
   # システムリソース確認
   htop
   free -h
   df -h
   ```

2. **データベース最適化**
   ```sql
   -- 実行計画確認
   EXPLAIN ANALYZE SELECT * FROM tasks WHERE status = 'pending';
   
   -- インデックス作成
   CREATE INDEX idx_tasks_created_at ON tasks(created_at);
   
   -- 統計情報更新
   ANALYZE tasks;
   ```

3. **ログ設定調整**
   ```bash
   # ログレベル調整（本番環境）
   # app/backend/.env
   LOG_LEVEL=WARNING
   DEBUG=False
   ```

## セキュリティ関連の問題

### 8. 認証・認可エラー

#### 問題：APIアクセス時に認証エラーが発生する

**解決方法**：

1. **環境変数確認**
   ```bash
   # シークレットキー確認
   docker compose exec backend echo $SECRET_KEY
   
   # 本番環境では強力なキーに変更
   export SECRET_KEY=$(openssl rand -hex 32)
   ```

2. **CORS設定確認**
   ```python
   # 本番環境でのCORS設定
   allow_origins=["https://yourdomain.com"]  # 本番ドメイン
   ```

## データ関連の問題

### 9. データベースデータ消失

#### 問題：コンテナ再起動後にデータが消える

**解決方法**：

1. **ボリューム設定確認**
   ```bash
   # ボリューム一覧確認
   docker volume ls
   
   # ボリューム詳細確認
   docker volume inspect taskmanager_postgres_data
   ```

2. **データバックアップ復元**
   ```bash
   # データベースダンプ作成
   docker compose exec database pg_dump -U postgres taskmanager > backup.sql
   
   # データベース復元
   docker compose exec -T database psql -U postgres taskmanager < backup.sql
   ```

### 10. マイグレーションエラー

#### 問題：データベーススキーマ変更が適用されない

**解決方法**：

1. **手動マイグレーション実行**
   ```bash
   # データベースコンテナで手動実行
   docker compose exec database psql -U postgres taskmanager -f /docker-entrypoint-initdb.d/init.sql
   ```

2. **スキーマ確認**
   ```sql
   -- テーブル構造確認
   \d tasks
   
   -- インデックス確認
   \di
   ```

## 開発環境固有の問題

### 11. WSL2 での問題（Windows）

#### 問題：ファイル変更が反映されない・パフォーマンスが悪い

**解決方法**：

1. **WSL2内でのプロジェクト配置**
   ```bash
   # WSL2内にプロジェクトを配置
   cd /home/username/
   git clone <repository> taskmanager
   ```

2. **ファイル監視設定**
   ```bash
   # WSL2でのファイル監視限界値変更
   echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
   sudo sysctl -p
   ```

### 12. Mac での問題

#### 問題：Apple Silicon (M1/M2) での Docker イメージエラー

**解決方法**：

1. **プラットフォーム指定**
   ```yaml
   # docker-compose.yml
   services:
     database:
       image: postgres:15-alpine
       platform: linux/amd64  # 追加
   ```

2. **Dockerビルド設定**
   ```bash
   # multi-platform ビルド
   docker buildx build --platform linux/amd64,linux/arm64 .
   ```

## 緊急時対応

### 13. システム全体リセット

**すべてをクリーンアップして再構築**：

```bash
# 1. 全コンテナ・ボリューム削除
docker compose down -v --rmi all

# 2. システムクリーンアップ
docker system prune -a -f

# 3. 再ビルド・起動
docker compose up --build -d

# 4. データベース初期化確認
docker compose exec database psql -U postgres -d taskmanager -c "\dt"
```

### 14. ログ収集

**問題発生時のログ収集**：

```bash
# 全サービスのログ収集
docker compose logs > debug_logs.txt

# システム情報収集
docker info > system_info.txt
docker compose config > compose_config.txt

# リソース使用量
docker stats --no-stream > resource_usage.txt
```

## 問い合わせ先

### サポート情報
- **技術的な問題**: 開発チームに連絡
- **緊急時対応**: システム管理者に連絡
- **バグ報告**: Issue管理システムに登録

### 関連ドキュメント
- [環境構築手順書](./環境構築手順書.md)
- [API仕様書](./API一覧.md)
- [データベース設計書](./テーブル定義書.md)

---

**作成日**: 2025-07-21  
**更新日**: 2025-07-21  
**作成者**: 開発チーム  
**バージョン**: 1.0