# タスク管理アプリ 環境構築手順書

## 概要

本文書は、タスク管理アプリケーションのDocker環境を構築するための手順書です。

### システム構成
- **フロントエンド**: React Router V7 (Node.js 20)
- **バックエンド**: FastAPI (Python 3.11)
- **データベース**: PostgreSQL 15
- **コンテナ**: Docker Compose

### 使用ポート
- フロントエンド: `http://localhost:3000`
- バックエンド API: `http://localhost:8000`
- データベース: `localhost:5432`

## 前提条件

### 必要なソフトウェア
以下のソフトウェアがインストールされていることを確認してください：

1. **Docker Engine** (バージョン 20.0以上)
   ```bash
   docker --version
   # Docker version 20.10.0 以上が必要
   ```

2. **Docker Compose** (バージョン 2.0以上)
   ```bash
   docker compose version
   # Docker Compose version v2.0.0 以上が必要
   ```

3. **Git** (ソースコード取得用)
   ```bash
   git --version
   ```

### システム要件
- **OS**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **メモリ**: 4GB以上推奨
- **ディスク容量**: 5GB以上の空き容量

## 環境構築手順

### 1. ソースコードの取得

```bash
# プロジェクトディレクトリにクローン
git clone <リポジトリURL> taskmanager
cd taskmanager
```

### 2. プロジェクト構造の確認

```
taskmanager/
├── docker-compose.yml      # Docker Compose設定
├── app/
│   ├── frontend/          # React Router V7アプリ
│   │   ├── Dockerfile
│   │   ├── package.json
│   │   └── app/
│   ├── backend/           # FastAPIアプリ
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── app/
│   └── database/          # DB初期化スクリプト
│       └── init.sql
└── doc/                   # ドキュメント
```

### 3. 環境変数の設定

#### バックエンド環境設定
```bash
# app/backend/.env を作成
cd app/backend
cat > .env << EOF
# データベース接続設定
DATABASE_URL=postgresql://postgres:postgres@database:5432/taskmanager

# アプリケーション設定
PYTHONPATH=/app
DEBUG=True

# セキュリティ設定（本番環境では変更してください）
SECRET_KEY=your-secret-key-change-in-production
ACCESS_TOKEN_EXPIRE_MINUTES=30
EOF
```

#### フロントエンド環境設定（オプション）
```bash
# app/frontend/.env を作成（必要に応じて）
cd ../frontend
cat > .env << EOF
# APIエンドポイント
REACT_APP_API_URL=http://localhost:8000

# 開発設定
NODE_ENV=development
EOF
```

### 4. Docker イメージのビルドと起動

#### 全サービスの起動
```bash
# プロジェクトルートディレクトリで実行
cd ../../
docker compose up --build -d
```

#### 個別サービスの起動（開発時）
```bash
# データベースのみ起動
docker compose up database -d

# バックエンドのみ起動
docker compose up backend -d

# フロントエンドのみ起動
docker compose up frontend -d
```

### 5. サービスの起動確認

#### コンテナの状態確認
```bash
docker compose ps
```

期待される出力例：
```
NAME                     COMMAND                  SERVICE             STATUS              PORTS
taskmanager-backend      "uvicorn main:app --…"   backend             running             0.0.0.0:8000->8000/tcp
taskmanager-db           "docker-entrypoint.s…"   database            running             0.0.0.0:5432->5432/tcp
taskmanager-frontend     "docker-entrypoint.s…"   frontend            running             0.0.0.0:3000->3000/tcp
```

#### サービスの動作確認
```bash
# データベース接続確認
docker compose exec database pg_isready -U postgres -d taskmanager

# バックエンドAPI確認
curl http://localhost:8000/health

# フロントエンド確認
curl http://localhost:3000
```

### 6. アプリケーションへのアクセス

- **フロントエンド**: http://localhost:3000
- **バックエンドAPI**: http://localhost:8000
- **API ドキュメント**: http://localhost:8000/docs

## データベース初期化

### 自動初期化
Docker Compose起動時に自動的に以下が実行されます：

1. PostgreSQLデータベース作成
2. ユーザー `taskuser` の作成
3. `tasks` テーブルの作成
4. インデックスの作成

### 手動初期化（必要時）
```bash
# データベースコンテナに接続
docker compose exec database psql -U postgres -d taskmanager

# テーブル確認
\dt

# サンプルデータ確認
SELECT * FROM tasks;
```

## 開発モード

### ホットリロード開発
```bash
# 全サービスを開発モードで起動
docker compose up

# ログを表示しながら起動
docker compose up --build

# 特定のサービスのログを表示
docker compose logs -f backend
docker compose logs -f frontend
```

### ローカル開発（Dockerなし）

#### バックエンド開発
```bash
cd app/backend

# 仮想環境作成
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係インストール
pip install -r requirements.txt

# 開発サーバー起動
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### フロントエンド開発
```bash
cd app/frontend

# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev
```

## テスト実行

### バックエンドテスト
```bash
# コンテナ内でテスト実行
docker compose exec backend pytest

# ローカルでテスト実行
cd app/backend
source venv/bin/activate
pytest -v
```

### フロントエンドテスト
```bash
# コンテナ内でテスト実行
docker compose exec frontend npm test

# ローカルでテスト実行
cd app/frontend
npm test
```

### 統合テスト
```bash
# 統合テストスクリプト実行
python integration_test.py

# モック統合テスト実行
python mock_backend_test.py
```

## データバックアップと復元

### データベースバックアップ
```bash
# データベースダンプ作成
docker compose exec database pg_dump -U postgres taskmanager > backup.sql

# 特定テーブルのみバックアップ
docker compose exec database pg_dump -U postgres -t tasks taskmanager > tasks_backup.sql
```

### データベース復元
```bash
# データベース復元
docker compose exec -T database psql -U postgres taskmanager < backup.sql
```

### データボリューム管理
```bash
# データボリューム確認
docker volume ls | grep taskmanager

# データボリュームバックアップ
docker run --rm -v taskmanager_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/db_backup.tar.gz -C /data .

# データボリューム復元
docker run --rm -v taskmanager_postgres_data:/data -v $(pwd):/backup alpine tar xzf /backup/db_backup.tar.gz -C /data
```

## 本番環境デプロイ

### 本番用設定変更

#### docker-compose.prod.yml
```yaml
version: '3.8'

services:
  database:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  backend:
    build:
      context: ./app/backend
      dockerfile: Dockerfile.prod
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${POSTGRES_DB}
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: false
    restart: always

  frontend:
    build:
      context: ./app/frontend
      dockerfile: Dockerfile.prod
    environment:
      REACT_APP_API_URL: ${API_URL}
    restart: always

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - frontend
      - backend
    restart: always
```

#### 本番環境起動
```bash
# 本番環境用起動
docker compose -f docker-compose.prod.yml up -d

# 本番環境用環境変数
export POSTGRES_DB=taskmanager_prod
export POSTGRES_USER=taskuser_prod
export POSTGRES_PASSWORD=secure_password
export SECRET_KEY=production_secret_key
export API_URL=https://your-domain.com/api
```

## 環境のクリーンアップ

### 開発環境リセット
```bash
# 全コンテナ停止・削除
docker compose down

# データボリューム含めて削除
docker compose down -v

# イメージも削除
docker compose down --rmi all -v

# システム全体のクリーンアップ
docker system prune -a
```

### 部分的クリーンアップ
```bash
# 停止中のコンテナのみ削除
docker container prune

# 未使用のイメージを削除
docker image prune

# 未使用のボリュームを削除
docker volume prune
```

## 監視とログ

### ログ確認
```bash
# 全サービスのログ表示
docker compose logs

# 特定サービスのログ表示
docker compose logs backend
docker compose logs frontend
docker compose logs database

# リアルタイムログ監視
docker compose logs -f

# 最新100行のログ表示
docker compose logs --tail=100
```

### ヘルスチェック
```bash
# サービス死活監視
curl -f http://localhost:8000/health || echo "Backend is down"
curl -f http://localhost:3000 || echo "Frontend is down"

# データベース接続確認
docker compose exec database pg_isready -U postgres -d taskmanager
```

### パフォーマンス監視
```bash
# コンテナリソース使用量
docker stats

# 特定コンテナの詳細情報
docker compose top backend
docker compose top frontend
docker compose top database
```

## セキュリティ設定

### 環境変数の暗号化
```bash
# .env.example を作成（サンプル用）
cp app/backend/.env app/backend/.env.example

# 実際の .env は .gitignore に追加
echo "app/backend/.env" >> .gitignore
echo "app/frontend/.env" >> .gitignore
```

### ネットワークセキュリティ
```bash
# 外部からのアクセス制限（本番環境）
# docker-compose.yml でポート公開を制限
# ports:
#   - "127.0.0.1:5432:5432"  # データベースはローカルのみ
```

### SSL/TLS設定（本番環境）
- リバースプロキシ（Nginx）の設定
- Let's Encrypt証明書の取得
- HTTPS通信の強制

## よくある質問

### Q: コンテナが起動しない
A: 以下を確認してください：
1. Dockerサービスが起動しているか
2. ポートが他のプロセスで使用されていないか
3. ディスク容量が十分あるか

### Q: データベース接続エラー
A: 以下を確認してください：
1. データベースコンテナが正常に起動しているか
2. 環境変数が正しく設定されているか
3. ネットワーク設定が適切か

### Q: フロントエンドが表示されない
A: 以下を確認してください：
1. Node.jsのバージョンが対応しているか
2. npm installが正常に完了しているか
3. APIエンドポイントが正しく設定されているか

## サポート情報

### 関連ドキュメント
- [API仕様書](./API一覧.md)
- [データベース設計書](./テーブル定義書.md)
- [テスト実施方法書](./テスト実施方法書.md)

### 技術サポート
- 技術的な問題は開発チームにお問い合わせください
- バグ報告はIssue管理システムに登録してください

---

**作成日**: 2025-07-21  
**更新日**: 2025-07-21  
**作成者**: 開発チーム  
**バージョン**: 1.0