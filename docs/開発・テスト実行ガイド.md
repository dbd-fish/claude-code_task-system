# 開発・テスト実行ガイド

## 📋 概要

このガイドでは、タスク管理システムの開発時に使用する単体テスト、Lint、コードフォーマットなどの実行方法を詳しく説明します。

## 🧪 テスト・Lint実行方法

> **⚠️ 重要**: 各コマンドは指定されたディレクトリで実行してください

### フロントエンド (React + TypeScript)
**実行場所: `frontend/` ディレクトリ**

#### 🔍 基本的なテスト実行

```bash
# プロジェクトルートから移動
cd frontend

# 単体テストの実行（インタラクティブモード）
npm test

# 全テストを一度だけ実行
npm test -- --watchAll=false

# 特定ファイルのテスト実行
npm test Login.test.tsx

# カバレッジレポート生成
npm run test:coverage
```

#### 📊 テストカバレッジの確認
**実行場所: `frontend/` ディレクトリ**

```bash
# プロジェクトルートから移動
cd frontend
npm run test:coverage

# カバレッジレポートの場所
# coverage/lcov-report/index.html をブラウザで開く
```

#### ✨ ESLint実行
**実行場所: `frontend/` ディレクトリ**

```bash
# プロジェクトルートから移動
cd frontend

# ESLintチェック（Create React Appに内蔵）
npx eslint src/

# 自動修正可能なエラーを修正
npx eslint src/ --fix

# TypeScriptの型チェック
npx tsc --noEmit
```

#### 🎨 コードフォーマット (Prettier)
**実行場所: `frontend/` ディレクトリ**

```bash
# プロジェクトルートから移動
cd frontend

# Prettierでコードフォーマット
npx prettier --write "src/**/*.{ts,tsx,js,jsx,css,md}"

# フォーマットチェック（修正なし）
npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"
```

### バックエンド (Node.js + Express)
**実行場所: `backend/` ディレクトリ**

#### 🔍 基本的なテスト実行

```bash
# プロジェクトルートから移動
cd backend

# 単体テストの実行
npm test

# 統合テストの実行
npm run test:integration

# 統合テストの実行・検証
npm run test:integration:run
npm run test:integration:validate

# 特定テストファイルの実行
npx jest controllers/authController.test.js

# カバレッジレポート生成
npx jest --coverage
```

#### 🔧 個別テスト実行
**実行場所: `backend/` ディレクトリ**

```bash
# プロジェクトルートから移動
cd backend

# 認証機能のテスト
npm run test:auth

# タスク機能のテスト
npm run test:tasks

# 特定のテストパターンを実行
npx jest --testNamePattern="User model"
```

#### ✨ ESLint・コードチェック
**実行場所: `backend/` ディレクトリ**

```bash
# プロジェクトルートから移動
cd backend

# JavaScript用ESLint実行（設定が必要）
npx eslint "**/*.js"

# 自動修正
npx eslint "**/*.js" --fix

# Node.js用のコードスタイルチェック
npx standard --fix  # Standard.jsスタイル（オプション）
```

## 🐳 Docker環境でのテスト実行

### Docker コンテナ内でのテスト
**実行場所: プロジェクトルート（ホスト側）**

```bash
# 本番環境でのテスト
# フロントエンドテスト（本番環境ではnginxのため実行不可）
docker-compose -f docker-compose.prod.yml exec frontend npm test -- --watchAll=false

# バックエンドテスト  
# ホスト: プロジェクトルート → コンテナ内: /app
docker-compose -f docker-compose.prod.yml exec backend npm test

# 統合テスト
# ホスト: プロジェクトルート → コンテナ内: /app  
docker-compose -f docker-compose.prod.yml exec backend npm run test:integration
```

### コンテナ内に直接接続してテスト実行

```bash
# 開発環境のバックエンドコンテナに接続
docker exec -it task-manager-backend-dev bash
# コンテナ内カレントディレクトリ: /app
npm test
npm run test:integration

# 開発環境のフロントエンドコンテナに接続
docker exec -it task-manager-frontend-dev bash  
# コンテナ内: /app
npm test -- --watchAll=false

# 本番環境のコンテナに接続
docker exec -it task-manager-backend-prod bash   # バックエンド（/app）
docker exec -it task-manager-frontend-prod bash  # フロントエンド（nginx、テスト実行不可）
```

### Docker環境での開発モード
**実行場所: プロジェクトルート（ホスト側）**

```bash
# 開発モードでコンテナ起動（ホットリロード有効）
docker-compose up -d

# ファイル変更監視テスト（フロントエンド）
docker-compose exec frontend npm test

# 本番環境起動
docker-compose -f docker-compose.prod.yml up -d
```

### 開発用Dockerコンテナでのテスト

```bash
# 開発用コンテナ起動（docker-compose.yml使用）
docker-compose up -d

# バックエンドテスト
# ホスト: プロジェクトルート → コンテナ内: /app
docker-compose exec backend npm test

# フロントエンド開発用テスト（開発用コンテナの場合）
# ホスト: プロジェクトルート → コンテナ内: /app
docker-compose exec frontend npm test
```

## 📝 設定ファイルの詳細

### フロントエンド設定

#### Jest設定（package.jsonに含まれる）
```json
{
  "scripts": {
    "test": "react-scripts test",
    "test:coverage": "react-scripts test --coverage --watchAll=false"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  }
}
```

#### TypeScript設定 (tsconfig.json)
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx"
  },
  "include": ["src"]
}
```

### バックエンド設定

#### Jest設定 (jest.config.js - 作成推奨)
```javascript
module.exports = {
  testEnvironment: 'node',
  testMatch: [
    '**/tests/**/*.test.js',
    '**/__tests__/**/*.js',
    '**/*.(test|spec).js'
  ],
  collectCoverageFrom: [
    'controllers/**/*.js',
    'middleware/**/*.js',
    'models/**/*.js',
    'routes/**/*.js'
  ],
  coverageReporters: ['text', 'lcov', 'html'],
  coverageDirectory: 'coverage'
};
```

#### 統合テスト設定 (jest.integration.config.js)
```javascript
module.exports = {
  testEnvironment: 'node',
  testMatch: [
    '**/tests/integration/**/*.test.js'
  ],
  setupFilesAfterEnv: ['<rootDir>/tests/integration/setup.js'],
  collectCoverageFrom: [
    'controllers/**/*.js',
    'middleware/**/*.js',
    'models/**/*.js',
    'routes/**/*.js'
  ]
};
```

## 🔧 開発時のワークフロー

### 1. 機能開発時の推奨手順

```bash
# 1. 開発サーバー起動（各ディレクトリで実行）
cd frontend && npm start    # フロントエンド（frontend/ディレクトリ）
cd backend && npm run dev   # バックエンド（backend/ディレクトリ）

# 2. コード変更

# 3. テスト実行（各ディレクトリで実行）
cd frontend && npm test     # フロントエンド（frontend/ディレクトリ）
cd backend && npm test      # バックエンド（backend/ディレクトリ）

# 4. Lintチェック（各ディレクトリで実行）
cd frontend && npx eslint src/       # フロントエンド（frontend/ディレクトリ）
cd backend && npx eslint "**/*.js"   # バックエンド（backend/ディレクトリ）

# 5. コードフォーマット（各ディレクトリで実行）
cd frontend && npx prettier --write "src/**/*.{ts,tsx}"  # フロントエンド（frontend/ディレクトリ）
```

### 2. プルリクエスト前のチェック

```bash
# 全テスト実行（各ディレクトリで実行）
cd frontend && npm run test:coverage                    # フロントエンド（frontend/ディレクトリ）
cd backend && npm test && npm run test:integration      # バックエンド（backend/ディレクトリ）

# 型チェック（フロントエンド）
cd frontend && npx tsc --noEmit                        # フロントエンド（frontend/ディレクトリ）

# Lintエラーの修正（各ディレクトリで実行）
cd frontend && npx eslint src/ --fix                   # フロントエンド（frontend/ディレクトリ）
cd backend && npx eslint "**/*.js" --fix               # バックエンド（backend/ディレクトリ）

# ビルド確認
cd frontend && npm run build                           # フロントエンド（frontend/ディレクトリ）
```

## 📊 カバレッジ目標

### フロントエンド目標
- **関数**: 85%以上
- **行**: 85%以上
- **分岐**: 80%以上
- **文**: 85%以上

### バックエンド目標
- **関数**: 90%以上
- **行**: 90%以上
- **分岐**: 85%以上
- **文**: 90%以上

## 🛠️ よく使用するコマンド集

### フロントエンド
**実行場所: `frontend/` ディレクトリ**
```bash
# 開発サーバー起動
npm start

# テスト実行（対話モード）
npm test

# テスト実行（CI用）
npm test -- --ci --coverage --watchAll=false

# ビルド
npm run build

# 型チェック
npx tsc --noEmit

# ESLint
npx eslint src/ --fix

# Prettier
npx prettier --write "src/**/*.{ts,tsx,js,jsx,css,md}"
```

### バックエンド
**実行場所: `backend/` ディレクトリ**
```bash
# 開発サーバー起動
npm run dev

# テスト実行
npm test

# 統合テスト
npm run test:integration

# データベース操作
npm run migrate
npm run seed

# 個別テスト
npm run test:auth
npm run test:tasks
```

## 🔍 デバッグ・トラブルシューティング

### テスト関連のエラー

#### エラー: "Test suite failed to run"
```bash
# ローカル環境の場合（frontend/ または backend/ ディレクトリで実行）
rm -rf node_modules package-lock.json
npm install

# コンテナ内の場合
docker exec -it task-manager-backend bash
# コンテナ内: /app で実行
rm -rf node_modules package-lock.json
npm install
```

#### エラー: "Cannot find module"
```bash
# ローカル環境の場合（frontend/ または backend/ ディレクトリで実行）
npx tsc --noEmit  # TypeScript設定確認
npm install       # パッケージ再インストール

# コンテナ内の場合
docker exec -it task-manager-backend bash
# コンテナ内: /app で実行
npx tsc --noEmit
npm install
```

#### エラー: "Coverage threshold not met"
```bash
# カバレッジ詳細確認
npm run test:coverage
# coverage/lcov-report/index.html で詳細確認
```

### Lint関連のエラー

#### エラー: "Parsing error: Unexpected token"
```bash
# ESLint設定確認
cat .eslintrc.json

# TypeScript設定確認
cat tsconfig.json
```

#### エラー: "Prettier formatting conflicts"
```bash
# Prettierで自動修正
npx prettier --write "src/**/*.{ts,tsx}"
```

## 📈 継続的インテグレーション

### GitHub Actions用設定例

```yaml
name: Tests and Lint
on: [push, pull_request]

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: cd frontend && npm ci
      - run: cd frontend && npm run test:coverage
      - run: cd frontend && npx eslint src/
      - run: cd frontend && npm run build

  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: cd backend && npm ci
      - run: cd backend && npm test
      - run: cd backend && npm run test:integration
```

## ✅ チェックリスト

### 開発完了時の確認項目
- [ ] フロントエンド単体テスト全通過
- [ ] バックエンド単体テスト全通過
- [ ] 統合テスト全通過
- [ ] ESLintエラーなし
- [ ] TypeScript型エラーなし
- [ ] テストカバレッジ目標達成
- [ ] ビルド成功

---

**🚀 このガイドに従って、品質の高いコードを維持しましょう！**